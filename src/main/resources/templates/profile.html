<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản Lý Tài Khoản</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #f8f9fa; }
        .sidebar { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; }
        .sidebar a { display: block; padding: 15px 20px; color: #333; text-decoration: none; border-bottom: 1px solid #eee; transition: 0.3s; }
        .sidebar a:hover, .sidebar a.active { background-color: #e9ecef; color: #0d6efd; font-weight: bold; border-left: 4px solid #0d6efd; }
        .profile-card { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 30px; }
        .avatar-circle { width: 100px; height: 100px; background-color: #e9ecef; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; color: #6c757d; margin: 0 auto 20px; }

        .membership-card {
            background: linear-gradient(135deg, #1e1e2f 0%, #32325d 100%); /* Màu tối sang trọng */
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        .rank-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            font-weight: bold;
            padding: 5px 15px;
            border-radius: 20px;
            text-transform: uppercase;
            font-size: 0.8rem;
        }
        /* Màu sắc cho từng hạng */
        .rank-BRONZE { background-color: #cd7f32; color: white; }
        .rank-SILVER { background-color: #c0c0c0; color: #333; }
        .rank-GOLD { background-color: #ffd700; color: #333; }
        .rank-DIAMOND { background-color: #b9f2ff; color: #0047ab; box-shadow: 0 0 10px #b9f2ff; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/"><i class="fas fa-shopping-bag"></i> NHÓM 6 SHOP</a>
        <a href="/" class="btn btn-outline-light btn-sm"><i class="fas fa-arrow-left"></i> Tiếp tục mua sắm</a>
    </div>
</nav>

<div class="container">
    <div class="row">

        <div class="col-md-3 mb-4">
            <div class="membership-card shadow">
                <div id="rankBadge" class="rank-badge rank-BRONZE">BRONZE</div>
                <div class="mb-1 text-white-50 small">Thành viên</div>
                <h5 class="fw-bold mb-3" id="cardName">User Name</h5>

                <div class="d-flex justify-content-between align-items-end mb-1">
                    <span class="fs-4 fw-bold" id="pointDisplay">0</span>
                    <small class="text-white-50">điểm tích lũy</small>
                </div>

                <div class="progress" style="height: 6px; background-color: rgba(255,255,255,0.2);">
                    <div id="pointProgress" class="progress-bar bg-warning" style="width: 0%"></div>
                </div>
                <small class="mt-2 d-block text-white-50" id="nextLevelText">Cần thêm 1000 điểm để lên Silver</small>
            </div>
            <div class="sidebar">
                <div class="p-3 text-center border-bottom">
                    <div class="fw-bold" id="sidebarName">User Name</div>
                    <small class="text-muted" id="sidebarEmail">user@example.com</small>
                </div>
                <a href="/profile" class="active"><i class="fas fa-user-edit me-2"></i> Hồ sơ cá nhân</a>
                <a href="#" onclick="alert('Chức năng Lịch sử đơn hàng đang phát triển')"><i class="fas fa-history me-2"></i> Lịch sử đơn hàng</a>
                <a href="#" onclick="logout()" class="text-danger"><i class="fas fa-sign-out-alt me-2"></i> Đăng xuất</a>
            </div>
        </div>

        <div class="col-md-9">
            <div class="profile-card">
                <h4 class="mb-4 pb-2 border-bottom">Hồ Sơ Của Tôi</h4>

                <div class="text-center">
                    <div class="avatar-circle">
                        <i class="fas fa-user"></i>
                    </div>
                </div>

                <form id="profileForm">
                    <input type="hidden" id="userId">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-muted">Email (Không thể thay đổi)</label>
                            <input type="text" id="email" class="form-control bg-light" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Họ và Tên</label>
                            <input type="text" id="fullName" class="form-control" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Số điện thoại</label>
                            <input type="text" id="phone" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ngày sinh</label>
                            <input type="date" id="birthday" class="form-control">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Giới tính</label>
                        <div class="d-flex gap-4">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="gender" id="genderM" value="MALE">
                                <label class="form-check-label" for="genderM">Nam</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="gender" id="genderF" value="FEMALE">
                                <label class="form-check-label" for="genderF">Nữ</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="gender" id="genderO" value="OTHER">
                                <label class="form-check-label" for="genderO">Khác</label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Địa chỉ giao hàng mặc định</label>
                        <textarea id="address" class="form-control" rows="2" placeholder="Số nhà, đường..."></textarea>
                    </div>

                    <div class="text-end">
                        <button type="submit" class="btn btn-primary px-4 py-2" id="btnSave">
                            <i class="fas fa-save me-1"></i> Lưu Thay Đổi
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        loadUserProfile();
    });

    // 1. Tải thông tin User từ Server
    async function loadUserProfile() {
        const localUser = localStorage.getItem('currentUser');
        if (!localUser) {
            window.location.href = '/login';
            return;
        }

        const userId = JSON.parse(localUser).userId;

        try {
            const res = await fetch(`/api/users/${userId}`);
            if (res.ok) {
                const user = await res.json();

                // Điền dữ liệu vào form
                document.getElementById('userId').value = user.userId;
                document.getElementById('email').value = user.email;
                document.getElementById('fullName').value = user.fullName || '';
                document.getElementById('phone').value = user.phone || '';
                document.getElementById('address').value = user.address || '';
                document.getElementById('birthday').value = user.birthday || '';

                // Sidebar info
                document.getElementById('sidebarName').innerText = user.fullName || "User";
                document.getElementById('sidebarEmail').innerText = user.email;

                // Radio giới tính
                if (user.gender) {
                    document.querySelector(`input[name="gender"][value="${user.gender}"]`).checked = true;
                }
            }
        } catch (err) {
            console.error(err);
        }
    }

    // 2. Gửi cập nhật
    document.getElementById('profileForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const btn = document.getElementById('btnSave');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Đang lưu...';

        const genderEl = document.querySelector('input[name="gender"]:checked');

        const payload = {
            userId: document.getElementById('userId').value,
            fullName: document.getElementById('fullName').value,
            phone: document.getElementById('phone').value,
            address: document.getElementById('address').value,
            birthday: document.getElementById('birthday').value || null,
            gender: genderEl ? genderEl.value : null
        };

        try {
            const res = await fetch('/api/users/profile', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                const updatedUser = await res.json();

                // Cập nhật lại LocalStorage để các trang khác (như Home) hiện tên mới ngay lập tức
                // Giữ lại các field quan trọng cũ (như role, token nếu có) và ghi đè field mới
                const oldLocal = JSON.parse(localStorage.getItem('currentUser'));
                const newLocal = { ...oldLocal, ...updatedUser };
                localStorage.setItem('currentUser', JSON.stringify(newLocal));

                Swal.fire('Thành công', 'Thông tin đã được cập nhật!', 'success');

                // Update Sidebar ngay lập tức
                document.getElementById('sidebarName').innerText = updatedUser.fullName;
            } else {
                Swal.fire('Lỗi', 'Không thể cập nhật thông tin', 'error');
            }
        } catch (err) {
            Swal.fire('Lỗi', 'Lỗi kết nối server', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save me-1"></i> Lưu Thay Đổi';
        }
    });

    function logout() {
        localStorage.removeItem('currentUser');
        localStorage.removeItem('cart');
        window.location.href = '/login';
    }
</script>

</body>
</html>