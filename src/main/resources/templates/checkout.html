<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Thanh Toán Đơn Hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .form-label { font-weight: 600; color: #555; }
        .is-invalid { border-color: #dc3545; }
        .checkout-summary { position: sticky; top: 20px; }
    </style>
</head>
<body class="bg-light">

<div class="container py-5">
    <div class="row">
        <div class="col-12 mb-4">
            <h2 class="fw-bold text-center text-primary">XÁC NHẬN THANH TOÁN</h2>
            <div class="text-center text-muted">Vui lòng kiểm tra kỹ thông tin giao hàng</div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-7">
            <div class="card shadow-sm mb-4 border-0">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-map-marker-alt me-2 text-danger"></i>Thông tin nhận hàng</h5>
                </div>
                <div class="card-body p-4">
                    <form id="checkoutForm" class="needs-validation" novalidate>
                        <input type="hidden" id="userId">

                        <div class="mb-3">
                            <label class="form-label">Họ và Tên <span class="text-danger">*</span></label>
                            <input type="text" id="recipientName" class="form-control"
                                   placeholder="Nguyễn Văn A"
                                   minlength="2" maxlength="50"
                                   pattern="^[a-zA-Z\s\u00C0-\u1EF9]+$"
                                   required>
                            <div class="invalid-feedback">
                                (1E.2) Họ tên từ 2-50 ký tự, không chứa số hoặc ký tự đặc biệt.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                            <input type="tel" id="phone" class="form-control"
                                   placeholder="0912345678"
                                   pattern="0[0-9]{9}"
                                   maxlength="10"
                                   required>
                            <div class="invalid-feedback">
                                (1E.3) SĐT phải gồm 10 số và bắt đầu bằng số 0.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Địa chỉ nhận hàng <span class="text-danger">*</span></label>
                            <textarea id="address" class="form-control" rows="3"
                                      placeholder="Số nhà, Tên đường, Phường/Xã, Quận/Huyện..."
                                      minlength="10" maxlength="255"
                                      required></textarea>
                            <div class="invalid-feedback">
                                (1E.4) Địa chỉ quá ngắn (tối thiểu 10 ký tự).
                            </div>
                        </div>

                        <h5 class="fw-bold mt-4 mb-3"><i class="fas fa-credit-card me-2 text-primary"></i>Thanh toán</h5>
                        <div class="border rounded p-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="COD" checked>
                                <label class="form-check-label fw-bold" for="cod">
                                    Thanh toán khi nhận hàng (COD)
                                    <div class="text-muted small fw-normal">Chỉ áp dụng cho đơn dưới 20 triệu.</div>
                                </label>
                            </div>
                            <hr class="my-2">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="banking" value="BANKING">
                                <label class="form-check-label fw-bold" for="banking">
                                    Chuyển khoản Ngân hàng
                                    <div class="text-muted small fw-normal">Quét mã QR VietQR (Xử lý ngay).</div>
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card shadow border-0 checkout-summary">
                <div class="card-header bg-success text-white py-3">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-shopping-bag me-2"></i>Đơn hàng của bạn</h5>
                </div>
                <div class="card-body bg-white p-4">

                    <div id="orderItemsList" class="mb-3 custom-scrollbar" style="max-height: 350px; overflow-y: auto;">
                    </div>

                    <hr>

                    <label class="form-label small text-muted text-uppercase fw-bold">Mã giảm giá</label>
                    <div class="input-group mb-3">
                        <span class="input-group-text bg-white"><i class="fas fa-ticket-alt text-warning"></i></span>
                        <input type="text" id="voucherCode" class="form-control text-uppercase" placeholder="Nhập mã voucher">
                        <button class="btn btn-outline-dark" type="button" onclick="checkVoucherPreview()">Áp dụng</button>
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Tạm tính:</span>
                        <span id="subTotal" class="fw-bold">0 đ</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">Giảm giá:</span>
                        <span id="discountAmount" class="text-success fw-bold">- 0 đ</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span class="text-muted">Phí vận chuyển:</span>
                        <span class="text-success">Miễn phí</span>
                    </div>

                    <div class="border-top pt-3 d-flex justify-content-between align-items-center">
                        <span class="fs-5 fw-bold text-dark">Tổng thanh toán:</span>
                        <span id="finalTotal" class="fs-4 fw-bold text-danger">0 đ</span>
                    </div>

                    <button class="btn btn-success w-100 mt-4 py-3 fw-bold text-uppercase shadow-sm" id="btnOrder" onclick="validateAndSubmit()">
                        Xác nhận đặt hàng
                    </button>

                    <div class="text-center mt-3">
                        <a href="/" class="text-decoration-none text-muted small"><i class="fas fa-arrow-left me-1"></i> Quay lại mua sắm</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="serverIsBuyNow" th:value="${isBuyNow}">
<input type="hidden" id="serverProductId" th:if="${product != null}" th:value="${product.id}">
<input type="hidden" id="serverProductName" th:if="${product != null}" th:value="${product.name}">
<input type="hidden" id="serverProductPrice" th:if="${product != null}" th:value="${product.salePrice}">
<input type="hidden" id="serverProductImg" th:if="${product != null}" th:value="${product.thumbnail}">

<script>
    let checkoutItems = [];
    let currentTotal = 0;

    document.addEventListener("DOMContentLoaded", function() {
        // 1. Check Login & Load User Info
        const userStr = localStorage.getItem('currentUser');
        if (userStr) {
            const user = JSON.parse(userStr);
            document.getElementById('userId').value = user.userId;
            // Trim khoảng trắng theo đặc tả 2.2a
            document.getElementById('recipientName').value = (user.fullName || "").trim();
            document.getElementById('phone').value = (user.phone || "").trim();
            document.getElementById('address').value = (user.address || "").trim();
        } else {
            Swal.fire({
                title: 'Chưa đăng nhập',
                text: 'Vui lòng đăng nhập để thanh toán',
                icon: 'warning',
                confirmButtonText: 'Đăng nhập'
            }).then(() => window.location.href='/login');
            return;
        }

        // 2. Load Voucher từ LocalStorage (Nếu có từ trang Cart)
        const tempVoucher = localStorage.getItem('tempVoucher');
        if (tempVoucher) {
            document.getElementById('voucherCode').value = tempVoucher;
            localStorage.removeItem('tempVoucher'); // Clear sau khi load
        }

        // 3. Load sản phẩm (Buy Now hoặc Cart)
        const isBuyNow = document.getElementById('serverIsBuyNow').value === 'true';
        if (isBuyNow) {
            checkoutItems.push({
                productId: document.getElementById('serverProductId').value,
                name: document.getElementById('serverProductName').value,
                price: parseFloat(document.getElementById('serverProductPrice').value),
                thumbnail: document.getElementById('serverProductImg').value,
                quantity: 1
            });
        } else {
            const cartStr = localStorage.getItem('cart');
            if (cartStr) {
                checkoutItems = JSON.parse(cartStr);
            }
        }

        // Check 2E.1: Giỏ hàng rỗng
        if (checkoutItems.length === 0) {
            Swal.fire('Giỏ hàng trống', 'Vui lòng chọn sản phẩm', 'info').then(() => window.location.href='/');
            document.getElementById('btnOrder').disabled = true;
        } else {
            renderOrderItems();
        }
    });

    function renderOrderItems() {
        const container = document.getElementById('orderItemsList');
        let total = 0;
        let html = '';

        checkoutItems.forEach(item => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;
            html += `
                <div class="d-flex align-items-center mb-3">
                    <div class="position-relative">
                        <img src="${item.thumbnail}" class="rounded border" style="width: 60px; height: 60px; object-fit: cover;">
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-secondary small">${item.quantity}</span>
                    </div>
                    <div class="ms-3 flex-grow-1">
                        <div class="fw-bold text-dark text-truncate" style="max-width: 180px;">${item.name}</div>
                        <div class="text-muted small">${new Intl.NumberFormat('vi-VN').format(item.price)} ₫</div>
                    </div>
                    <div class="fw-bold text-primary">${new Intl.NumberFormat('vi-VN').format(itemTotal)} ₫</div>
                </div>
            `;
        });

        container.innerHTML = html;
        currentTotal = total;
        updatePriceUI(total, 0);
    }

    function updatePriceUI(subTotal, discount) {
        document.getElementById('subTotal').innerText = new Intl.NumberFormat('vi-VN').format(subTotal) + ' đ';
        document.getElementById('discountAmount').innerText = '- ' + new Intl.NumberFormat('vi-VN').format(discount) + ' đ';

        let final = subTotal - discount;
        if (final < 0) final = 0;
        document.getElementById('finalTotal').innerText = new Intl.NumberFormat('vi-VN').format(final) + ' đ';
    }

    // Hàm giả lập check voucher để hiển thị giá tạm (Thực tế nên gọi API check voucher riêng)
    function checkVoucherPreview() {
        const code = document.getElementById('voucherCode').value.trim();
        if(!code) {
            updatePriceUI(currentTotal, 0);
            return;
        }
        Swal.fire('Thông tin', 'Mã giảm giá sẽ được kiểm tra chính xác khi bạn bấm "Xác nhận đặt hàng".', 'info');
    }

    // --- LOGIC SUBMIT ĐƠN HÀNG (QUAN TRỌNG) ---
    async function validateAndSubmit() {
        const form = document.getElementById('checkoutForm');

        // 1. Validate phía Client (HTML5 Attributes)
        form.classList.add('was-validated'); // Hiện đỏ nếu sai pattern/required
        if (!form.checkValidity()) {
            Swal.fire({
                icon: 'error',
                title: 'Thông tin chưa hợp lệ',
                text: 'Vui lòng kiểm tra lại các trường báo đỏ (Họ tên, SĐT, Địa chỉ).'
            });
            return;
        }

        const btn = document.getElementById('btnOrder');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Đang xử lý...';
        btn.disabled = true;

        // 2. Chuẩn bị dữ liệu
        const orderPayload = {
            userId: document.getElementById('userId').value,
            recipientName: document.getElementById('recipientName').value,
            phone: document.getElementById('phone').value,
            address: document.getElementById('address').value,
            paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
            voucherCode: document.getElementById('voucherCode').value.trim(),
            items: checkoutItems.map(item => ({
                productId: item.id || item.productId,
                quantity: item.quantity,
                clientPrice: item.price // Gửi giá client lên để check [2E.5]
            }))
        };

        try {
            // 3. Gửi API
            const res = await fetch('/api/orders/checkout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderPayload)
            });

            // 4. Xử lý phản hồi
            // Vì Backend ném RuntimeException -> Trả về JSON lỗi message
            if (res.ok) {
                const data = await res.json();

                // [5S.1] Thành công
                if (document.getElementById('serverIsBuyNow').value !== 'true') {
                    localStorage.removeItem('cart'); // Xóa giỏ hàng
                }

                Swal.fire({
                    icon: 'success',
                    title: 'Đặt hàng thành công!',
                    html: `Mã đơn hàng: <b>#${data.id}</b><br>Tổng tiền: ${new Intl.NumberFormat('vi-VN').format(data.totalAmount)}đ`,
                    confirmButtonText: 'Xem đơn hàng',
                    allowOutsideClick: false
                }).then(() => {
                    // Chuyển hướng đến trang Profile (Lịch sử đơn) hoặc Trang chủ
                    window.location.href = '/profile';
                });

            } else {
                // Xử lý lỗi từ Backend (1E.x, 2E.x, 3E.x...)
                const errorText = await res.text();
                let errorMsg = errorText;

                // Nếu backend trả về JSON lỗi (đôi khi Spring trả JSON object)
                try {
                    const errObj = JSON.parse(errorText);
                    errorMsg = errObj.message || errObj.error || errorText;
                } catch(e) {}

                Swal.fire({
                    icon: 'error',
                    title: 'Không thể đặt hàng',
                    text: errorMsg // Hiển thị chính xác message backend trả về (VD: "3E.2: Mã hết hạn")
                });
            }
        } catch (err) {
            Swal.fire('Lỗi hệ thống', 'Không thể kết nối đến server', 'error');
            console.error(err);
        } finally {
            btn.innerHTML = 'XÁC NHẬN ĐẶT HÀNG';
            btn.disabled = false;
        }
    }
</script>

</body>
</html>