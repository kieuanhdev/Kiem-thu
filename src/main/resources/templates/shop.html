<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>C·ª≠a H√†ng Tr·ª±c Tuy·∫øn</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .product-card {
            transition: transform 0.3s;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        .product-img {
            height: 250px;
            object-fit: cover;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }
        .price-tag {
            color: #d32f2f;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .cart-badge {
            font-size: 0.7rem;
            position: absolute;
            top: 5px;
            right: 5px;
        }
        .cursor-pointer { cursor: pointer; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/"><i class="fas fa-shopping-bag"></i> NH√ìM 6 SHOP</a>

        <div class="d-flex align-items-center gap-3">
            <button class="btn btn-outline-light position-relative" onclick="openCartModal()">
                <i class="fas fa-shopping-cart"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cartCount">
                    0
                </span>
            </button>

            <div id="guest-section">
                <a href="/login" class="btn btn-warning btn-sm fw-bold">ƒêƒÉng nh·∫≠p</a>
            </div>

            <div id="user-section" class="d-none align-items-center text-white">
                <span class="me-2">Xin ch√†o, <b id="userNameDisplay">User</b></span>
                <div class="dropdown">
                    <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/profile"><i class="fas fa-user-cog me-2"></i> T√†i kho·∫£n c·ªßa t√¥i</a></li>

                        <li><a class="dropdown-item" href="/admin/dashboard" id="adminLink" style="display:none">Trang Qu·∫£n tr·ªã</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()">ƒêƒÉng xu·∫•t</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>

<div class="container py-5">
    <div class="alert alert-info d-flex justify-content-between align-items-center">
        <span>üéâ Gi·∫£m gi√° 10% cho th√†nh vi√™n m·ªõi! Nh·∫≠p m√£: <b>NEWUSER</b></span>
        <button class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4">
        <div class="col" th:each="p : ${products}">
            <div class="card h-100 product-card">
                <img th:src="${p.thumbnail}" class="product-img" alt="Product Image">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title text-truncate" th:text="${p.name}">T√™n SP</h5>

                    <div class="mt-auto">
                        <div class="mb-2">
                            <span class="price-tag" th:text="${#numbers.formatDecimal(p.salePrice, 0, 'COMMA', 0, 'POINT')} + ' ƒë'"></span>
                        </div>

                        <div class="d-flex gap-2">
                            <a th:href="@{/checkout-page(productId=${p.id})}" class="btn btn-primary flex-grow-1">
                                Mua Ngay
                            </a>
                            <button class="btn btn-outline-success"
                                    onclick="addToCart('[[${p.id}]]', '[[${p.name}]]', '[[${p.salePrice}]]', '[[${p.thumbnail}]]')">
                                <i class="fas fa-cart-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-shopping-cart"></i> Gi·ªè H√†ng C·ªßa B·∫°n</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-hover align-middle">
                        <thead class="table-light sticky-top">
                        <tr>
                            <th>S·∫£n ph·∫©m</th>
                            <th>Gi√°</th>
                            <th>SL</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody id="cartItemsBody"></tbody>
                    </table>
                </div>

                <div class="border-top pt-3 mt-3">
                    <div class="row">
                        <div class="col-md-7">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-ticket-alt"></i></span>
                                <input type="text" id="cartVoucherInput" class="form-control" placeholder="Nh·∫≠p m√£ Voucher (n·∫øu c√≥)">
                            </div>
                        </div>
                        <div class="col-md-5 text-end">
                            <div class="fs-5 fw-bold">
                                T·ªïng: <span id="cartTotal" class="text-danger">0 ƒë</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-success" onclick="processCheckout()">Thanh To√°n</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // --- KHU V·ª∞C X·ª¨ L√ù AUTH (ƒêƒÉng nh·∫≠p/ƒêƒÉng xu·∫•t) ---

    // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p khi t·∫£i trang
    document.addEventListener("DOMContentLoaded", function() {
        checkLoginStatus();
        loadCart();
    });

    function checkLoginStatus() {
        const userStr = localStorage.getItem('currentUser');
        const guestSection = document.getElementById('guest-section');
        const userSection = document.getElementById('user-section');

        if (userStr) {
            const user = JSON.parse(userStr);
            // ·∫®n n√∫t ƒëƒÉng nh·∫≠p, hi·ªán t√™n user
            guestSection.classList.add('d-none');
            userSection.classList.remove('d-none');
            userSection.classList.add('d-flex');

            document.getElementById('userNameDisplay').innerText = user.fullName || user.email;

            // N·∫øu l√† Admin th√¨ hi·ªán th√™m link v√†o trang qu·∫£n tr·ªã
            if (user.role === 'ADMIN') {
                document.getElementById('adminLink').style.display = 'block';
            }
        } else {
            // Hi·ªán n√∫t ƒëƒÉng nh·∫≠p
            guestSection.classList.remove('d-none');
            userSection.classList.add('d-none');
            userSection.classList.remove('d-flex');
        }
    }

    function logout() {
        Swal.fire({
            title: 'ƒêƒÉng xu·∫•t?',
            text: "B·∫°n c√≥ ch·∫Øc mu·ªën tho√°t t√†i kho·∫£n kh√¥ng?",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'ƒêƒÉng xu·∫•t'
        }).then((result) => {
            if (result.isConfirmed) {
                // X√≥a th√¥ng tin kh·ªèi LocalStorage
                localStorage.removeItem('currentUser');
                // Reload trang ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán
                window.location.reload();
            }
        })
    }

    // --- KHU V·ª∞C X·ª¨ L√ù GI·ªé H√ÄNG (CART) ---

    let cart = [];

    function loadCart() {
        const savedCart = localStorage.getItem('cart');
        if (savedCart) {
            cart = JSON.parse(savedCart);
        }
        updateCartBadge();
    }

    function saveCart() {
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartBadge();
    }

    function addToCart(id, name, price, thumbnail) {
        // Ki·ªÉm tra xem s·∫£n ph·∫©m ƒë√£ c√≥ trong gi·ªè ch∆∞a
        const existingItem = cart.find(item => item.id === id);

        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            cart.push({ id, name, price, thumbnail, quantity: 1 });
        }

        saveCart();

        // Hi·ªáu ·ª©ng th√¥ng b√°o nh·ªè g√≥c m√†n h√¨nh (Toast)
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 1500,
            timerProgressBar: true
        })
        Toast.fire({
            icon: 'success',
            title: 'ƒê√£ th√™m v√†o gi·ªè h√†ng'
        })
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        saveCart();
        renderCartItems(); // Render l·∫°i modal
    }

    function updateCartBadge() {
        // T√≠nh t·ªïng s·ªë l∆∞·ª£ng item
        const count = cart.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById('cartCount').innerText = count;
    }

    function openCartModal() {
        renderCartItems();
        new bootstrap.Modal(document.getElementById('cartModal')).show();
    }

    function renderCartItems() {
        const tbody = document.getElementById('cartItemsBody');
        tbody.innerHTML = '';
        let total = 0;

        if (cart.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">Gi·ªè h√†ng tr·ªëng</td></tr>';
        } else {
            cart.forEach((item, index) => {
                total += item.price * item.quantity;
                tbody.innerHTML += `
                    <tr>
                        <td><img src="${item.thumbnail}" style="width: 50px; height: 50px; object-fit: cover;"></td>
                        <td>${item.name}</td>
                        <td>${new Intl.NumberFormat('vi-VN').format(item.price)} ƒë</td>
                        <td>
                            <input type="number" min="1" value="${item.quantity}"
                                   class="form-control form-control-sm" style="width: 60px"
                                   onchange="updateQuantity(${index}, this.value)">
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="removeFromCart(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }
        document.getElementById('cartTotal').innerText = new Intl.NumberFormat('vi-VN').format(total) + ' ƒë';
    }

    function updateQuantity(index, newQty) {
        if (newQty < 1) newQty = 1;
        cart[index].quantity = parseInt(newQty);
        saveCart();
        renderCartItems(); // C·∫≠p nh·∫≠t l·∫°i t·ªïng ti·ªÅn
    }

    function processCheckout() {
        if (cart.length === 0) {
            Swal.fire('Gi·ªè h√†ng tr·ªëng', 'Vui l√≤ng ch·ªçn s·∫£n ph·∫©m tr∆∞·ªõc', 'warning');
            return;
        }

        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
        const user = localStorage.getItem('currentUser');
        if (!user) {
            Swal.fire({
                title: 'Y√™u c·∫ßu ƒëƒÉng nh·∫≠p',
                text: "B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ thanh to√°n",
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'ƒêƒÉng nh·∫≠p ngay'
            }).then((res) => {
                if(res.isConfirmed) window.location.href = '/login';
            });
            return;
        }

        // 1. L∆∞u m√£ Voucher t·∫°m v√†o LocalStorage ƒë·ªÉ trang Checkout ƒë·ªçc ƒë∆∞·ª£c
        const voucherCode = document.getElementById('cartVoucherInput').value.trim();
        if (voucherCode) {
            localStorage.setItem('tempVoucher', voucherCode);
        } else {
            localStorage.removeItem('tempVoucher');
        }

        // 2. Chuy·ªÉn h∆∞·ªõng sang trang thanh to√°n (Kh√¥ng k√®m ID -> Ch·∫ø ƒë·ªô Cart)
        window.location.href = '/checkout-page';
    }
</script>

</body>
</html>